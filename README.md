# karat-challenge
Simulates an AWS serverless cloud application to handle stripe events as well as implements a simple web dashboard with a graphql backend 

![](/karat_screenshot.png)

### Table of Contents
- [Usage](#usage)
  - [Turn on Web-App](#turn-on-web-app)
  - [Adding New Users](#adding-new-users)
  - [Switching Users](#switching-users)
  - [Turn on Serverless Event System](#turn-on-serverless-event-system)
- [Architecture](#architecture)
  - [Architecture Diagram](#architecture)
  - [Tech Stack](#tech-stack)

### Prereqs
1. install `docker` & `docker-compose`
2. install [`awscli`](https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2-mac.html)
``` bash
curl "https://awscli.amazonaws.com/AWSCLIV2.pkg" -o "AWSCLIV2.pkg"
sudo installer -pkg AWSCLIV2.pkg -target /
```
3. install `yarn`
``` bash
brew install yarn
```
4. Remaining prereqs can be acquired by running  `yarn install`
### Usage
This project is setup as a mono-repo and includes all the components necessary to run a full-stack application. There are also several users preseeded in the database.

##### Turn on Web-App
1. Run `docker-compose up -d dashboard` to enable the frotnend app, backend (hasura) and database (postgres).
2. Navigate to localhost:3000 

##### Adding New Users
To add a new user you must update the `users` and `cards` table in postgres.
1. Find and copy the desired cardholder_id on stripe `ich_xxx` 
2. Add a user row to the postgres table `users` using the card_holder_id from above
3. Find and copy a stripe `card_id` from the above cardholder_id `ic_xxx` 
4. Add a card row to the postgres table `cards` using the `card_id` and `card_holder_id` above
##### Switching Users
By default the data being viewed is of userId `` which has over 1000 transactions and authorizations. In order to view different user follow these steps
1. Navigate to `./ui/react-dashboard/src/index.tsx`
2. Update line 28 to be `'x-hasura-user-id': '<user_id>'`
 
`user_id` is an autogenerated primary key in the postgres database. There is an association to the stripe `card_holder_id` on a user as well. You can choose

##### Turn on Serverless Event System
1.  Run `docker-compose up -d localstack`. Ensure that this step has completed by checking `localhost:4566/health` and verifying that all services are 'running'. (remove the `-d` if you'd like to see the lambdas & serverless enviornment logs, you will need to open new terminals for the remaining steps in this case)
2.  Run `yarn run stripe-sls-sytem`. This will deploy all serverless components and startup the stripe event forwarding on your machine as the last step. Ensure this step is completed before moving on to the next. Do not terminate this terminal
3. Copy the webhook signing secret from the terminal above.
4. Open a new terminal at the root of the directory and run `yarn run store-stripe-signing-secret <webhook-signing-secret>`, pasting the the secret copied in step 4 to `<webhook-signing-secret>`
5. Go to the stripe dashboard and add authorizations. Note that closing the stripe event terminal will terminate the connection and you will need to run steps 3 through 5 again

### Architecture
The application is broken into 3 parts: 
1. A serverless cloud system responsible for reliably and scalibly handling stripe events. 
2. Hasura backend offering a permissioned graphql endpoint as the primary API 
3. A react frontend web application
#### Diagram
![](/karat-local-arch.png)
#### Tech Stack

* Tools
  - lerna & yarn workspaces
  - Docker
  - Serverless
  - Localstack
* Cloud
  - AWS Lambda - *FaaS*
  - AWS Api-Gateway - *Managed api gateway*
  - AWS Eventbridge - *Cloud event bus*
* Backend
  - Hasura - *BaaS application used to abstract SQL database into a GraphQL server*
  - Postgres - *SQL Database*
* Frontend
  - React/Create React App - *Frontend web framework*
  - Apollo Client 3 - *GraphQL client*
  - Material-UI - *components library*
